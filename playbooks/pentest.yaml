version: 3

placeholders:
  domain: "example.com"
  url: "https://example.com"
  outdir: "./out/{domain}"
  wordlist_small: "/usr/share/wordlists/seclists/Discovery/Web-Content/common.txt"
  wordlist_medium: "/usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt"

tasks:

  # =========================
  # PHASE 1 — RECON & SCANNING
  # =========================

  - id: subdomain_passive
    name: "Subdomains (passive)"
    phase: "Recon"
    tags: ["recon", "subdomains"]
    requires_tools: ["subfinder", "amass"]
    produces_files:
      - "{outdir}/subs.txt"
    modes:
      fast:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: "subfinder -d {domain} -all -silent | sort -u | tee {outdir}/subs.txt"
      deep:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              (subfinder -d {domain} -all -silent; amass enum -passive -d {domain}) | sort -u | tee {outdir}/subs.txt
      stealth:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              subfinder -d {domain} -silent | sort -u | tee {outdir}/subs.txt

  - id: web_alive
    name: "Alive web hosts (probe)"
    phase: "Scanning"
    tags: ["recon", "http", "probe"]
    requires_tools: ["httpx"]
    requires_files:
      - "{outdir}/subs.txt"
    produces_files:
      - "{outdir}/alive_hosts.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/subs.txt | sort -u | httpx -silent -follow-redirects -status-code -title -tech-detect | tee {outdir}/alive_hosts.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/subs.txt | sort -u | httpx -silent -follow-redirects -status-code -title -tech-detect -web-server -ip -cdn -asn -o {outdir}/alive_hosts.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/subs.txt | sort -u | httpx -silent -follow-redirects -status-code -title -rl 5 | tee {outdir}/alive_hosts.txt

  - id: url_collection
    name: "URL collection (crawl + history)"
    phase: "Recon"
    tags: ["recon", "urls", "crawl"]
    requires_tools: ["katana", "gau", "waybackurls"]
    requires_files:
      - "{outdir}/alive_hosts.txt"
    produces_files:
      - "{outdir}/crawl_urls.txt"
      - "{outdir}/historical_urls.txt"
      - "{outdir}/urls_all.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | katana -silent -depth 3 -jc -kf | tee {outdir}/crawl_urls.txt
          - cmd: |
              echo {domain} | gau --subs | tee {outdir}/historical_urls.txt
          - cmd: |
              echo {domain} | waybackurls | tee -a {outdir}/historical_urls.txt >/dev/null
          - cmd: |
              cat {outdir}/crawl_urls.txt {outdir}/historical_urls.txt | sort -u | tee {outdir}/urls_all.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | katana -silent -depth 5 -jc -kf | tee {outdir}/crawl_urls.txt
          - cmd: |
              echo {domain} | gau --subs | tee {outdir}/historical_urls.txt
          - cmd: |
              echo {domain} | waybackurls | tee -a {outdir}/historical_urls.txt >/dev/null
          - cmd: |
              cat {outdir}/crawl_urls.txt {outdir}/historical_urls.txt | sort -u | tee {outdir}/urls_all.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | katana -silent -depth 2 -jc -kf | tee {outdir}/crawl_urls.txt
          - cmd: |
              echo {domain} | gau --subs | tee {outdir}/historical_urls.txt
          - cmd: |
              cat {outdir}/crawl_urls.txt {outdir}/historical_urls.txt | sort -u | tee {outdir}/urls_all.txt

  # =========================
  # PHASE 2 — JS & PARAMETERS
  # =========================

  - id: js_discovery
    name: "JavaScript file discovery"
    phase: "Vuln Analysis"
    tags: ["js", "endpoints"]
    requires_tools: ["grep", "sort", "tee"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/js_urls.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/urls_all.txt | grep -iE '\.js(\?|$)' | sort -u | tee {outdir}/js_urls.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/urls_all.txt | grep -iE '\.js(\?|$)' | sort -u | tee {outdir}/js_urls.txt
          - cmd: |
              cat {outdir}/crawl_urls.txt 2>/dev/null | grep -iE '\.js(\?|$)' | sort -u | tee -a {outdir}/js_urls.txt >/dev/null
          - cmd: |
              sort -u {outdir}/js_urls.txt -o {outdir}/js_urls.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/urls_all.txt | grep -iE '\.js(\?|$)' | head -200 | sort -u | tee {outdir}/js_urls.txt

  - id: js_endpoints
    name: "JS endpoint extraction"
    phase: "Vuln Analysis"
    tags: ["js", "endpoints"]
    requires_tools: ["curl", "grep", "sort", "tee", "xargs"]
    requires_files:
      - "{outdir}/js_urls.txt"
    produces_files:
      - "{outdir}/js_endpoints.txt"
      - "{outdir}/js_secret_hints.txt"
    modes:
      fast:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              cat {outdir}/js_urls.txt | xargs -I{} sh -c 'curl -s -L "{}" | grep -Eo "(https?://[^\"'\''[:space:]]+|/[-A-Za-z0-9_./?=&%]+)"' | sort -u | tee {outdir}/js_endpoints.txt
      deep:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              cat {outdir}/js_urls.txt | xargs -I{} sh -c 'curl -s -L "{}" | grep -Eo "(https?://[^\"'\''[:space:]]+|/[-A-Za-z0-9_./?=&%]+)"' | sort -u | tee {outdir}/js_endpoints.txt
          - cmd: |
              cat {outdir}/js_urls.txt | xargs -I{} sh -c 'curl -s -L "{}" | grep -Ein "(api[_-]?key|token|secret|bearer|authorization|x-api-key|jwt)"' | tee {outdir}/js_secret_hints.txt
      stealth:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              cat {outdir}/js_urls.txt | head -50 | xargs -I{} sh -c 'curl -s -L "{}" | grep -Eo "(https?://[^\"'\''[:space:]]+|/[-A-Za-z0-9_./?=&%]+)"' | sort -u | tee {outdir}/js_endpoints.txt
    notes:
      - "Heuristic only. Validate manually."

  - id: param_discovery
    name: "Parameter discovery (names)"
    phase: "Vuln Analysis"
    tags: ["params", "idor", "sqli", "xss", "ssrf", "redirect"]
    requires_tools: ["grep", "sed", "sort", "tee"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/params.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep '?' {outdir}/urls_all.txt | sed 's/=.*/=/' | sort -u | tee {outdir}/params.txt
      deep:
        commands:
          - cmd: |
              grep '?' {outdir}/urls_all.txt | sed 's/[#].*$//' | sed 's/=.*/=/' | sort -u | tee {outdir}/params.txt
      stealth:
        commands:
          - cmd: |
              grep '?' {outdir}/urls_all.txt | head -500 | sed 's/=.*/=/' | sort -u | tee {outdir}/params.txt

  # =========================
  # PHASE 3 — VULNERABILITY TRACKS (CANDIDATES + SAFE CHECKS)
  # =========================

  - id: idor_candidates
    name: "IDOR / BOLA candidates"
    phase: "Vuln Analysis"
    tags: ["idor", "bola", "authz"]
    requires_tools: ["grep", "sort", "tee"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/idor_candidates.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep -Ei '\b(id|user_id|uid|account_id|order_id|invoice_id|profile_id)=' {outdir}/urls_all.txt | sort -u | tee {outdir}/idor_candidates.txt
      deep:
        commands:
          - cmd: |
              grep -Ei '\b(id|user_id|uid|account_id|order_id|invoice_id|profile_id|tenant|org|organization)=' {outdir}/urls_all.txt | sort -u | tee {outdir}/idor_candidates.txt
      stealth:
        commands:
          - cmd: |
              grep -Ei '\b(id|user_id|uid|account_id)=' {outdir}/urls_all.txt | head -200 | sort -u | tee {outdir}/idor_candidates.txt
    notes:
      - "Best validated with two accounts (A vs B)."

  - id: auth_header_cookie_audit
    name: "Auth/session header & cookie audit (quick)"
    phase: "Vuln Analysis"
    tags: ["auth", "cookies", "headers"]
    requires_tools: ["curl", "egrep", "awk", "xargs"]
    requires_files:
      - "{outdir}/alive_hosts.txt"
    produces_files:
      - "{outdir}/auth_headers_audit.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -120 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -skI "{}" | egrep -i "set-cookie|location|cache-control|pragma|expires|strict-transport-security|content-security-policy|x-frame-options|x-content-type-options"; echo' | tee {outdir}/auth_headers_audit.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -250 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -skI "{}" | egrep -i "set-cookie|location|cache-control|pragma|expires|strict-transport-security|content-security-policy|x-frame-options|x-content-type-options|referrer-policy|permissions-policy"; echo' | tee {outdir}/auth_headers_audit.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -50 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -skI "{}" | egrep -i "set-cookie|cache-control|strict-transport-security|content-security-policy"; echo' | tee {outdir}/auth_headers_audit.txt

  - id: cors_misconfig_check
    name: "CORS misconfiguration check"
    phase: "Vuln Analysis"
    tags: ["cors", "misconfig"]
    requires_tools: ["curl", "egrep", "awk", "xargs"]
    requires_files:
      - "{outdir}/alive_hosts.txt"
    produces_files:
      - "{outdir}/cors_check.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -200 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -sk -H "Origin: https://evil.com" -I "{}" | egrep -i "access-control-allow-origin|access-control-allow-credentials"; echo' | tee {outdir}/cors_check.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -400 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -sk -H "Origin: https://evil.com" -I "{}" | egrep -i "access-control-allow-origin|access-control-allow-credentials|vary"; echo' | tee {outdir}/cors_check.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | head -60 | \
              xargs -I{} sh -c 'echo "== {} =="; curl -sk -H "Origin: https://evil.com" -I "{}" | egrep -i "access-control-allow-origin|access-control-allow-credentials"; echo' | tee {outdir}/cors_check.txt

  - id: open_redirect_candidates
    name: "Open redirect candidates + quick follow test"
    phase: "Vuln Analysis"
    tags: ["redirect"]
    requires_tools: ["grep", "sort", "tee", "curl", "xargs"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/redirect_candidates.txt"
      - "{outdir}/redirect_test.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep -Ei '\b(redirect|return|next|url|dest|destination|continue)=http' {outdir}/urls_all.txt | sort -u | tee {outdir}/redirect_candidates.txt
          - cmd: |
              cat {outdir}/redirect_candidates.txt | head -60 | xargs -I{} sh -c 'curl -sk -o /dev/null -w "%{http_code} %{redirect_url}\n" "{}"' | tee {outdir}/redirect_test.txt
      deep:
        commands:
          - cmd: |
              grep -Ei '\b(redirect|return|next|url|dest|destination|continue)=|/redirect|/logout' {outdir}/urls_all.txt | sort -u | tee {outdir}/redirect_candidates.txt
          - cmd: |
              cat {outdir}/redirect_candidates.txt | head -120 | xargs -I{} sh -c 'curl -sk -o /dev/null -w "%{http_code} %{redirect_url}\n" "{}"' | tee {outdir}/redirect_test.txt
      stealth:
        commands:
          - cmd: |
              grep -Ei '\b(redirect|return|next|url)=http' {outdir}/urls_all.txt | head -80 | sort -u | tee {outdir}/redirect_candidates.txt

  - id: ssrf_candidates
    name: "SSRF candidates (validate with Collaborator/Interactsh)"
    phase: "Vuln Analysis"
    tags: ["ssrf"]
    requires_tools: ["grep", "sort", "tee"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/ssrf_candidates.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep -Ei '\b(url|uri|webhook|callback|fetch|proxy|image|dest)=|/proxy|/fetch|/url' {outdir}/urls_all.txt | sort -u | tee {outdir}/ssrf_candidates.txt
      deep:
        commands:
          - cmd: |
              grep -Ei '\b(url|uri|webhook|callback|fetch|proxy|image|dest|target|endpoint|host)=|/proxy|/fetch|/url' {outdir}/urls_all.txt | sort -u | tee {outdir}/ssrf_candidates.txt
      stealth:
        commands:
          - cmd: |
              grep -Ei '\b(url|webhook|callback|proxy)=' {outdir}/urls_all.txt | head -200 | sort -u | tee {outdir}/ssrf_candidates.txt

  - id: upload_candidates
    name: "File upload / import attack surface"
    phase: "Vuln Analysis"
    tags: ["upload", "files"]
    requires_tools: ["grep", "sort", "tee"]
    requires_files:
      - "{outdir}/js_endpoints.txt"
    produces_files:
      - "{outdir}/upload_candidates.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep -Ei '(upload|import|avatar|file|attachment|media|image)' {outdir}/js_endpoints.txt | sort -u | tee {outdir}/upload_candidates.txt
      deep:
        commands:
          - cmd: |
              grep -Ei '(upload|import|avatar|file|attachment|media|image|document|csv|xml|backup)' {outdir}/js_endpoints.txt | sort -u | tee {outdir}/upload_candidates.txt
      stealth:
        commands:
          - cmd: |
              grep -Ei '(upload|import|avatar|file)' {outdir}/js_endpoints.txt | head -150 | sort -u | tee {outdir}/upload_candidates.txt

  - id: api_surface_discovery
    name: "API surface discovery (GraphQL/Swagger/OpenAPI)"
    phase: "Vuln Analysis"
    tags: ["api", "graphql", "swagger"]
    requires_tools: ["grep", "sort", "tee"]
    requires_files:
      - "{outdir}/urls_all.txt"
    produces_files:
      - "{outdir}/api_surface.txt"
    modes:
      fast:
        commands:
          - cmd: |
              grep -Ei '(graphql|swagger|openapi|api-docs|swagger-ui|redoc)' {outdir}/urls_all.txt | sort -u | tee {outdir}/api_surface.txt
      deep:
        commands:
          - cmd: |
              grep -Ei '(graphql|swagger|openapi|api-docs|swagger-ui|redoc|/v1/|/v2/|/api/)' {outdir}/urls_all.txt | sort -u | tee {outdir}/api_surface.txt
      stealth:
        commands:
          - cmd: |
              grep -Ei '(graphql|swagger|openapi)' {outdir}/urls_all.txt | head -120 | sort -u | tee {outdir}/api_surface.txt

  - id: sensitive_files_ffuf
    name: "Sensitive files quick check (low noise)"
    phase: "Scanning"
    tags: ["misconfig", "exposure"]
    requires_tools: ["ffuf"]
    produces_files:
      - "{outdir}/ffuf_sensitive.json"
    modes:
      fast:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              ffuf -u {url}/FUZZ -w {wordlist_small} -t 40 -fc 404 -o {outdir}/ffuf_sensitive.json -of json
      deep:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              ffuf -u {url}/FUZZ -w {wordlist_medium} -t 60 -fc 404 -o {outdir}/ffuf_sensitive.json -of json
      stealth:
        commands:
          - cmd: "mkdir -p {outdir}"
          - cmd: |
              ffuf -u {url}/FUZZ -w {wordlist_small} -t 10 -rate 5 -fc 404 -o {outdir}/ffuf_sensitive.json -of json

  - id: nuclei_mh_critical
    name: "Nuclei (medium/high/critical triage)"
    phase: "Scanning"
    tags: ["nuclei", "misconfig"]
    requires_tools: ["nuclei"]
    requires_files:
      - "{outdir}/alive_hosts.txt"
    produces_files:
      - "{outdir}/nuclei_findings.txt"
    modes:
      fast:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | nuclei -silent -severity medium,high,critical | tee {outdir}/nuclei_findings.txt
      deep:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | nuclei -silent -severity low,medium,high,critical | tee {outdir}/nuclei_findings.txt
      stealth:
        commands:
          - cmd: |
              cat {outdir}/alive_hosts.txt | awk '{print $1}' | sort -u | nuclei -silent -rl 5 -severity medium,high,critical | tee {outdir}/nuclei_findings.txt

  # =========================
  # PHASE 4 — EXPLOIT SUPPORT (CLI-FIRST PROXY HELPERS)
  # =========================

  - id: proxy_quickstart_mitmproxy
    name: "Proxy quickstart (mitmproxy) + curl through proxy"
    phase: "Exploit Support"
    tags: ["proxy", "mitmproxy", "learning"]
    requires_tools: ["mitmproxy", "curl"]
    modes:
      fast:
        commands:
          - cmd: |
              echo "1) Start proxy:"; echo "   mitmproxy -p 8080"
          - cmd: |
              echo "2) Test with curl through proxy:"; echo "   curl -k -x http://127.0.0.1:8080 {url}"
          - cmd: |
              echo "3) Browser proxy: HTTP+HTTPS -> 127.0.0.1:8080 (then browse target)"
      deep:
        commands:
          - cmd: |
              echo "Start mitmproxy and save flows:"; echo "mitmproxy -p 8080 -w {outdir}/mitmproxy.flows"
          - cmd: |
              echo "Later view saved flows:"; echo "mitmproxy -r {outdir}/mitmproxy.flows"
      stealth:
        commands:
          - cmd: |
              echo "Keep scope tight and browsing minimal (reduce noise + rate limits)."
